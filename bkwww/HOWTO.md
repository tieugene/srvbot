# HowTo

## 1. Setup

Скрипт расчитан на работу от root'а.  
Для работы необходимо создать следующие файлы и папки (см папку [`src/`](src)):

- `/usr/local/bin/bkwww.sh` - собственно скрипт, скопировать [как есть](src/usr/local/bin/bkwww.sh)
- `/usr/local/etc/bkwww.conf` - конфиг к скрипту, обязателен, *примерно* [так](src/usr/local/etc/bkwww.conf)
- `~/.my.cnf` - атрибуты доступа к базе MySQL, обязательно, *примерно* [так](src/my.cnf)
- `/etc/cron.daily/z_bkwww` - обязательно, скопировать [как есть](src/etc/cron.daily/z_bkwww)
- `/var/log/bkwww/` - обязательно (для логов)
- `/usr/local/lib/bkwww_x.lst` - опция (если нужны исключения), *примерно* [так](src/usr/local/lib/bkwww_x.lst) (все пути - относительно $SRC в конфиге)
- `/etc/logrotate.d/bkwww` - опция (если нужен logrotate), скопировать [как есть](src/etc/logrotate.d/bkwww)

После установки всего этого крайне желательно протестировать вручную:

```bash
/usr/local/bin/bkwww.sh
```

## 2. Schedule

Бэкапы делаются ежедневно в `cron.daily`, то есть примерно в 3 часа ночи.  
Хранится (цифры по умолчанию, настраиваются в конфиге):

- 7 последних ежедневных
- 5 последних еженедельных (копия воскресенья ночь)
- 3 (по-умолчанию) последних ежемесячных (копия на 1-е число месяца ночь)

## 3. Backup

Как оно работает:

1. читается конфиг
1. создаетеся новая папка
1. готовятся сервисы (останавливается nginx (если запущен), стартует mariadb (если остановлен))
1. собственно бэкапы:
  - база: `mysqldump ...`
  - файлы: `rsync ... --link-local ...`
1. сервисы возвращаются в исходное состояние
1. ротация ежедневных/еженедельных/ежемесячных бэкапов

### _Нюансы_
Так как файлы бэкапятся `rsync --link-local`, то:

- новые и измененные "со вчера" файлы копируются _как есть_
- не изменившиеся "со вчера" создаются как *хардлинки* "вчерашних"

Отсюда &oplus;:

- итоговые дополнительные (со "вчера") расходы диска - только на изменившиеся файлы и бэкап базы
- для восстановления файлов достаточно просто скопировать папку (хотя лучше `rsync`'ом)

НО &ominus;:

- необходимо учитывать, что *обычно* большинство файлов в бэкапе - *хардлинки*
- поэтому удаление любого бэкапа весом в десятки гигов _не_ приводит к увеличению свободного места на диске на соответствующую сумму. Или приводит. It depends.
- определить реально занимаемое бэкапами место - `man du`

## 3. Restore

Допустим:

- бэкап: `/mnt/shares/backup/0.day/<YYMMDD>/`
- сайт: `/mnt/shares/www/site/`

Проверка что изменилось в файлах (текущее относительно бэкапа):  
*(note: базу так просто не сравнить)*

```bash
rsync -anivxAHX --del /mnt/shares/backup/0.day/<YYMMDD>/site/ /mnt/shares/www/site/
```

Восстановление:

```bash
systemctl stop nginx
systemctl stop php-fpm
zstdcat /mnt/shares/backup/0.day/<YYMMDD>/db.sql.zst | mysql <dbname>
rsync -axAHX --del /mnt/shares/backup/0.day/<YYMMDD>/site/ /mnt/shares/www/site/
systemctl start php-fpm
systemctl start nginx
```

## 4. Troubleshuting
Если что-то пошло не так:

- Если папка *YYMMDD* создалась, *частично* заполнилась, но во время собственно бэкапа случился сбой, то второй раз в этот день `bkwww.sh` не сработает. В этому случае неудачную папку *YYMMDD* надо удалить руками.
- Если предыдущая папка ("вчера") получилась почти пустой, то следующий бэкап ("сегодня") будет больше на разницу (вплоть до копируется всё заново полностью); в этом случае (если можно и нужно) лучше сымитировать полный бэкап "за вчера", сделав hardlink copy "позавчера" во "вчера" *(предварительно удалив `<вчера>/site`)*:  
  `cp -aL <позавчера>/site <вчера>` 
